# Fig Tmux Integration: Enabled
# source-file ~/.fig/tmux
# End of Fig Tmux Integration

############
# settings #
############

# Set default shell to zsh
run-shell 'tmux set-option -g default-shell "$(command -v zsh)"'

# set first window to index 1 (not 0) to map more to the keyboard layout
set -g base-index 1
set -g pane-base-index 1

# Show tmux positions in titles
set -g set-titles on
set-window-option -g automatic-rename off

# Set the hidstory limit so we get lots of scrollback.
#setw -g history-limit 50000

set -g mouse on


####################
# cosmetic changes #
####################

set -g status-style 'bg=colour18 fg=colour240'
# disable window name on the left side
set -g window-status-current-format ''
set -g window-status-format ''

# status bar window list styling
#setw -g window-status-current-style 'fg=colour1 bg=colour239 bold'
#setw -g window-status-current-format ' #I#[fg=colour249]:#[fg=colour255]#W#[fg=colour249]#F '

# Make active pane border blue
set -g pane-active-border-style fg=colour2

# Set the background color of the status bar
set -g status-bg colour234

# Set the left status to show all sessions with their windows
set -g status-left-length 100
set -g status-right-length 150
# This will show each session and its windows, highlighting the current one
set -g status-left '#[bg=colour235]#[fg=colour248]#{?client_prefix,#[bg=colour2]#[fg=colour0] PREFIX ,} #(~/.tmux-status-sessions.sh) #[fg=colour240]'
set -g status-interval 1  # Update every 1 second for responsive session display

# Hook to refresh status immediately on session/window changes
set-hook -g session-created 'refresh-client -S'
set-hook -g session-closed 'refresh-client -S'  
set-hook -g client-session-changed 'refresh-client -S'
set-hook -g window-renamed 'refresh-client -S'
#set -g status-right '%d/%m %H:%M'

# Common status bar components
STATUS_COMMON=' #[bg=colour237] #[fg=colour248]c#{cpu_fg_color}#{cpu_percentage} #[fg=colour248]r#{ram_fg_color}#{ram_percentage}'

# Conditional hostname coloring in status bar
%if "#{==:#{host},mfyz-remote}"
set -g status-right "${STATUS_COMMON} #[bg=colour208]#[fg=colour15] remote "
%elif "#{==:#{host},mfyz-server}"
set -g status-right "${STATUS_COMMON} #[bg=colour93]#[fg=colour15] home "
%elif "#{==:#{host},mfyz-rack}"
set -g status-right "${STATUS_COMMON} #[bg=colour196]#[fg=colour15] rack "
%else
set -g status-right "${STATUS_COMMON} #[bg=colour240]#[fg=colour248] #H "
%endif


################
# key bindings #
################

# remap prefix to backslash
set -g prefix '\'
unbind C-b
# Use Ctrl-\ to send a literal backslash
bind C-'\' send-keys '\'

# force a reload of the config file
unbind r
bind r \
     source-file ~/.tmux.conf \;\
         display 'Reloaded tmux config.'

# Rename current session with prefix n
unbind n
bind n command-prompt -I "#{session_name}" "rename-session '%%'"

# Vertical splits with g or C-g
unbind g 
unbind C-g
bind-key g split-window -h
bind-key C-g split-window -h

# Horizontal splits with v or C-h
unbind h
unbind C-h
bind-key h split-window
bind-key C-h split-window

# Ctrl - t or t new window
unbind t
unbind C-t
bind-key t new-window
bind-key C-t new-window

# Ctrl - w or w to kill panes
unbind w
unbind C-w
# bind-key w kill-pane
bind-key w confirm-before -p "kill-pane #W? (y/n)" kill-pane
bind-key C-w confirm-before -p "kill-pane #W? (y/n)" kill-pane

# Prefix q to kill session (switch to next session in creation order first)
unbind q
unbind C-q
bind-key q run-shell 'OLD_SESSION="#{session_name}"; ~/.tmux-switch-session.sh next; tmux kill-session -t "$OLD_SESSION"'
bind-key C-q run-shell 'OLD_SESSION="#{session_name}"; ~/.tmux-switch-session.sh next; tmux kill-session -t "$OLD_SESSION"'

# Switching panes with alt
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# resize panes with vim-style keys (uppercase)
bind-key K resize-pane -U 2
bind-key J resize-pane -D 2
bind-key H resize-pane -L 5
bind-key L resize-pane -R 5

# Ctrl + a + Pagedown : Next window
unbind Pagedown
bind-key Pagedown next-window

# Ctrl + a + Pagup : Previous window
unbind Pageup
bind-key Pageup previous-window

# Rebind c to create new session with pronounceable name
unbind c
bind-key c run-shell 'SESSION_NAME=$(~/.tmux-gen-session-name.sh); tmux new-session -d -s "$SESSION_NAME"; tmux switch-client -t "$SESSION_NAME"'

# Switch between sessions with Ctrl-Shift-Left/Right (creation time order)
bind -n C-S-Left run-shell '~/.tmux-switch-session.sh prev'
bind -n C-S-Right run-shell '~/.tmux-switch-session.sh next'

# Switch between sessions with prefix + Left/Right arrows (creation time order)
bind-key Left run-shell '~/.tmux-switch-session.sh prev'
bind-key Right run-shell '~/.tmux-switch-session.sh next'

# Kill current session and switch to next (creation order) with Ctrl-Shift-Q
bind -n C-S-Q run-shell 'OLD_SESSION="#{session_name}"; ~/.tmux-switch-session.sh next; tmux kill-session -t "$OLD_SESSION"'

#############
## plugins ##
#############

# Tmux plugin manager
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-cpu'

# CPU/RAM formatting - show only whole numbers without decimals
set -g @cpu_percentage_format "%.0f%%"
set -g @ram_percentage_format "%.0f%%"

set -g @plugin 'jaclu/tmux-menus'
set -g @menus_trigger 'Space'

run '~/.tmux/plugins/tpm/tpm'

